name: QA Automation Pipeline

env:
    JAVA_VERSION: '17'
    JAVA_DISTRIBUTION: 'temurin'
    
  
    ANDROID_PROFILE: Nexus 6
    ANDROID_TARGET: google_apis
    ANDROID_API_LEVEL: 28
    ANDROID_ARCH: x86_64
  
    
    ARTIFACT_NAME_REMOTE: allure-results-android-remote
    
    
    APK_URL: "https://github.com/webdriverio/native-demo-app/releases/download/v2.0.0/android.wdio.native.app.v2.0.0.apk"
    APK_PATH: "./apk/android.wdio.native.app.v2.0.0.apk"

on:
  push:
    branches: [main]
  pull_request:

jobs:
  # ==================================
  # WEB - Playwright
  # ==================================
  web-test:
    name: Web Automation
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./web-testing

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - run: npm install
      - run: npx playwright install --with-deps
      - run: npm run test

      - name: Upload Web Allure Results
        uses: actions/upload-artifact@v4
        with:
          name: web-allure-results
          path: web-testing/allure-results
          if-no-files-found: ignore

  # ==================================
  # API - Newman
  # ==================================
  api-test:
    name: API Automation
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./api-testing

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - run: npm install
        
      - name: Run API Test
        continue-on-error: true
        run: npm run start

      - name: Upload API Report
        uses: actions/upload-artifact@v4
        with:
          name: api-html-report
          path: api-testing/reporter
          if-no-files-found: ignore

  # ==================================
  # MOBILE - WDIO + EMULATOR
  # ==================================
  mobile-test: 
          name: Run Android Tests on Emulator
          runs-on: ubuntu-latest
          outputs:
            test_status: ${{ steps.run_tests.outcome }}
      
          steps:
            
            - name: Enable KVM
              run: |
                echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
                sudo udevadm control --reload-rules
                sudo udevadm trigger --name-match=kvm
      
            
            - name: Checkout project
              uses: actions/checkout@v4
      
            
            - name: Set up JDK 17
              uses: actions/setup-java@v3
              with:
                distribution: 'temurin'
                java-version: '17'
                
      
            
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                node-version: '18'
                cache: 'npm'
                cache-dependency-path: ./mobile-testing/package-lock.json
      
            
            - name: Install dependencies
              working-directory: ./mobile-testing
              run: |
                npm ci
                npm install -g appium@next
      
            
            - name: Download APK
              working-directory: ./mobile-testing
              run: |
                mkdir -p apk
                echo "ðŸ“¥ Downloading APK from ${{ env.APK_URL }}"
                curl -L -o ${{ env.APK_PATH }} ${{ env.APK_URL }}
                echo "âœ… APK downloaded to ${{ env.APK_PATH }}"
                ls -la apk/
      
            
            - name: Setup Appium drivers
              working-directory: ./mobile-testing
              run: |
                appium driver install uiautomator2
                appium driver list --installed
      
            
            - name: Build TypeScript
              working-directory: ./mobile-testing
              run: npm run build || echo "No build script, skipping"
      
            
            - name: Run tests on Android emulator
              id: run_tests
              uses: reactivecircus/android-emulator-runner@v2
              with:
                api-level: ${{ env.ANDROID_API_LEVEL }}
                target: ${{ env.ANDROID_TARGET }}
                arch: ${{ env.ANDROID_ARCH }}
                profile: ${{ env.ANDROID_PROFILE }}
                emulator-options: -no-snapshot -no-audio -no-window -gpu swiftshader_indirect -no-accel
                disable-animations: true
                working-directory: ./mobile-testing
                script: |
                  echo "ðŸš€ Emulator is starting..."
                  
                  # Tunggu emulator boot
                  adb wait-for-device
                  adb shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
                  echo "âœ… Emulator boot completed"
                  
                  # Disable animations
                  adb shell settings put global window_animation_scale 0
                  adb shell settings put global transition_animation_scale 0
                  adb shell settings put global animator_duration_scale 0
                  
                  # Install APK
                  echo "ðŸ“² Installing APK..."
                  adb install ${{ env.APK_PATH }}
                  echo "âœ… APK installed"
                  
                  # Verifikasi APK
                  adb shell pm list packages | grep wdio
                  
                  # Start Appium
                  echo "ðŸš€ Starting Appium server..."
                  npx appium --log-level debug --log appium.log &
                  sleep 10
                  
                  
                  echo "ðŸ§ª Running WebdriverIO tests..."
                  npm run wdio || true
                  
                  # Matikan emulator
                  adb emu kill || true
                  echo "âœ… Emulator stopped"
      
            
            - name: Upload Appium logs
              if: always()
              uses: actions/upload-artifact@v4
              with:
                name: appium-logs
                path: ./mobile-testing/appium.log
                if-no-files-found: ignore
      
            
            - name: Upload Allure Results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                name: ${{ env.ARTIFACT_NAME_REMOTE }}
                path: |
                  ./mobile-testing/allure-results
                  ./mobile-testing/test-results
                if-no-files-found: ignore
      
            
            - name: Test Status Summary
              if: always()
              run: |
                echo "## ðŸ“± Android Test Results" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                
                if [[ "${{ steps.run_tests.outcome }}" == "success" ]]; then
                  echo "âœ… **All tests passed!**" >> $GITHUB_STEP_SUMMARY
                else
                  echo "âš ï¸ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ“Š Check the artifacts:" >> $GITHUB_STEP_SUMMARY
                  echo "- [Allure Results](${{ env.ARTIFACT_NAME_REMOTE }})" >> $GITHUB_STEP_SUMMARY
                  echo "- [Appium Logs](appium-logs)" >> $GITHUB_STEP_SUMMARY
                fi